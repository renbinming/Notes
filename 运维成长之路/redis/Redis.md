
集群部署规则
- 每对主从实例端口相同且唯一
- 单实例内存 < 10G  方便后期维护
- 机器部署实例数 < CPU 核心的1.5倍  避免对CPU使用过度
- 机器选择：使用内存 < 总内存使用中位数 + 10%  使用内存使用率低的机器
- 同集群在相同机器不允许超过 3个 分片    一个集群，在一台机器上，不允许超过3个，流量激增的时候，一台机器不至于过多实例，导致内存不够

部署自动化流程
1. 填写参数（集群名、跨机房属性、集群分片数、单分片大小）
2. 任务提交到队列中，队列调度任务，执行部署
		选择机器
		按照规则生成主机名和端口
		对应机器执行部署、建立主从，agent 执行shell命令
		部署哨兵
		注册服务，写入集群名、对外提供ip及端口，写到配置中心 zookeeper
1. 部署出错进行重试，成功把信息返回


自动化迁移
- 单实例迁移（slave，master 需要切换成slave）
- 资源均衡迁移（高使用率的，迁移到相对空闲的机器）
- 集群迁移（跨机房部署）
- 整机迁移（下线服务，机器故障）

迁移流程
1. 选择迁移方式（对应不同的脚本）
2. 检查源实例角色（主，需要切换角色），对业务有影响
3. 从，先部署新的Redis实例，部署告警
4. 与源实例的主节点建立复制
5. 卸载老实例，删除告警
6. 重制哨兵
	
集群扩缩容

连接 集群配置信息
应用服务配置zk地址，namespace
假设是Java service，再根据 ip/port 连接 Redis 分片

redis 读写
连接redis——读写key——计算key的hash值——找到对应分片

![[Pasted image 20231106182018.png]]
namespace(集群名称)
cluster_ip (集群ip)
cluster_port(集群端口)
range_start(分片起始)
range_end(分片结尾)

配置中心只存主库IP


切换（）


监控数据采集
- 实例巡检
	- 内存用量
	- 内存使用率
	- CPU 使用率
	- 网络带宽
	- 连接数
	- 大key
	- 空闲key
- 集群巡检
	- 内存使用大，有大key 
	- 是否跨机房部署
	- 热点分片（分片的CPU使用率，热点）
	- 部署密集
- 机器巡检
计算分析

展示


nrpe
collectd
watcher


平台化后，还需要的工作
